<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Microsites on local</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <table id="micrositeListTable" class="table table-striped table-bordered micrositeTable">
  <caption>Microsites</caption>
  <thead>
    <tr>
    <th><i class="icon-th"></i></th>
    <th><i class="icon-star-empty"></i>&nbsp;Site Name</th>
    <th><i class="icon-calendar"></i>&nbsp;Created</th>
    <!-- <th><i class="icon-upload"></i>&nbsp;Releases</th>
    <th><i class="icon-time"></i>&nbsp;Last Release</th> -->
    <th>Local</th>
    <th>PD</th>
    <th>Preview</th>
    <th><i class="icon-star"></i>&nbsp;Published</th>
    <tr>
  </thead>
  <tfoot>
    <tr>
    <td class="micrositeTableFooterCpation" colspan="99">Retired microsites</td>
    </tr>
  </tfoot>
  <tbody>
  </tbody>
  </table>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.0.0/moment.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/1.0.0-rc.3/handlebars.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/tablesort/1.6.1/tablesort.min.js"></script>
  <script>

    // table sorting
    new Tablesort(document.getElementById('micrositeListTable'));

    $(document).on('ready', function() {

      // for now using a symlink to actual json file...
      function getMicrositeList( ) {
        return $.getJSON('micrositeListClone.json').pipe(function (data) {
          return data.sites;
        });
      }

      // moment.js lib
      moment().format();

      var list = getMicrositeList(),
          arr = [],
          rows = { 'sites': []},
          rowsRetired = { 'sites': []},
          rowsCount = 1,
          rowsRetiredCount = 1,
          created,
          ifEmbedded = '',
          data = {},
          rowHtml = '{{#sites}}' +
                    '<tr>' +
                    '<td class="count">{{ num }}</td>' +
                    '<td><a href="{{ localPath }}">{{ name }}</a></td>' +
                    '<td class="createDate">{{ createDate }}</td>' +
                    // '<td class="releases">{{ releases }}</td>' +
                    // '<td>{{ lastRelease }}</td>' +
                    '<td class="localSite"><a href="{{ localPath }}"><i class="icon-edit"></i></a></td>' +
                    '<td class="pdSite"><a href="{{ pdPath }}"><i class="icon-share"></i></a></td>' +
                    '<td class="previewSite"><a href="{{ previewPath }}"><i class="icon-check"></i></a></td>' +
                    '<td><a href="{{ sitePath }}">{{ sitePath }}</a></td>' +
                    '</tr>' +
                    '{{/sites}}',
          template = Handlebars.compile(rowHtml);

      var getRowCount = function (type) {
        if (type === 'published') {
          return rowsCount;
        } else if (type === 'retired') {
          return rowsRetiredCount;
        }
      }

      list.done(function (items) {

        // get array of site names
        for (var site in items) {
          arr.push(site);
        }

        // sort array on alpha site name
        arr.sort();

        var buildRows = function (type, i) {

          ifEmbedded = (items[ arr[i] ].isEmbedded) ? 'embedded.html' : '';

          data = {
            num: getRowCount(type),
            name: arr[i],
            createDate: moment( new Date(items[ arr[i] ].createDate) ).format('YYYY / MM / DD'),
            releases: items[ arr[i] ].releases.count,
            lastRelease: moment( items[ arr[i] ].releases.last ).fromNow(),
            localPath: '/sites/' + items[ arr[i] ].siteDirectory + '/' + ifEmbedded,
            pdPath: 'http://productdevelopment.techtarget.com/microsites/media.techtarget.com/' + items[ arr[i] ].siteDirectory + '/' + ifEmbedded,
            previewPath: items[ arr[i] ].urlPreview,
            sitePath: items[ arr[i] ].url
          };

          if (type === 'published') {
            rows.sites.push(data);
            rowsCount++;
          } else if (type === 'retired') {
            rowsRetired.sites.push(data);
            rowsRetiredCount++;
          }

        };

        // iterrate through json and build table rows
        for (var i = 0, len = arr.length; i < len; i++) {

          // filter out "inactive" sites
          if (items[ arr[i] ].isActive) {
            buildRows('published', i);
          } else {
            buildRows('retired', i);
          }

        }

        // append row template
        var table = $('#micrositeListTable');
        table
          .find('tbody')
          .append( template(rows) )
          .end()
          .find('tfoot')
          .append( template(rowsRetired) );

        // open links in new window
        $('#micrositeListTable').on('click', 'td', function (e) {
          e.preventDefault();
          var href = $(this).children('a').attr('href');
          if (typeof href !== 'undefined') {
            window.open( href );
          }
        });

      });

    });
  </script>

</body>
</html>